<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Video Chat</title>
    <style>
      body {
        text-align: center;
        background-color: black;
        color: white;
      }
      video {
        width: 45%;
        border-radius: 10px;
        margin: 5px;
        border: 2px solid cyan;
      }
      button {
        padding: 10px;
        margin: 10px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h1>Video Chat</h1>
    <div id="videos">
      <video id="local-video" autoplay muted></video>
      <video id="remote-video" autoplay></video>
    </div>
    <button onclick="startCall()">Start Call</button>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer/simplepeer.min.js"></script>
    <script>
      const socket = io("https://anonymous-chat-backend-jquo.onrender.com");
      let peer;

      socket.on("user-connected", (userId) => {
        createPeer(userId);
      });

      socket.on("offer", handleOffer);
      socket.on("answer", handleAnswer);
      socket.on("ice-candidate", handleIceCandidate);

      async function startCall() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        document.getElementById("local-video").srcObject = stream;
        const roomId = "video-room";
        socket.emit("join-room", roomId);
      }

      function createPeer(userId) {
        peer = new SimplePeer({
          initiator: true,
          trickle: false,
          stream: document.getElementById("local-video").srcObject,
        });

        peer.on("signal", (data) => {
          socket.emit("offer", { target: userId, signal: data });
        });

        peer.on("stream", (stream) => {
          document.getElementById("remote-video").srcObject = stream;
        });

        peer.on("ice-candidate", (candidate) => {
          socket.emit("ice-candidate", { target: userId, candidate });
        });
      }

      function handleOffer(payload) {
        peer = new SimplePeer({
          initiator: false,
          trickle: false,
          stream: document.getElementById("local-video").srcObject,
        });

        peer.on("signal", (data) => {
          socket.emit("answer", { target: payload.callerID, signal: data });
        });

        peer.on("stream", (stream) => {
          document.getElementById("remote-video").srcObject = stream;
        });

        peer.signal(payload.signal);
      }

      function handleAnswer(payload) {
        peer.signal(payload.signal);
      }

      function handleIceCandidate(payload) {
        peer.signal(payload.candidate);
      }
    </script>
  </body>
</html>
